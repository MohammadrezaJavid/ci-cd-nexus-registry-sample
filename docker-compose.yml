version: '3.4'

networks:
  default:
    name: dccn_net

volumes:
  traefik-acme:
    name: traefik_acme
  nexus-vol:
    name: nexus_vol

services:
  traefik-service:
    image: traefik:v2.4.8
    container_name: traefik
    ports:
      - 80:80
      - 443:443
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-acme:/acme
      - ./traefik:/traefik
    networks:
      - default
    command:
      - "--log.level=INFO"
      - "--log.filepath=/traefik.log"
      - "--log.format=json"

      - "--api=true"
      - "--ping=true"
      - "--accesslog=true"
      - "--accesslog.bufferingsize=100"
      - "--api.insecure=true"

      - "--providers.docker.endpoint=unix:///var/run/docker.sock"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=dccn_net"

      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"

      - "--providers.file.filename=/traefik/config.yml"

      #- "--entrypoints.web.address=:80"
      #- "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      #- "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      #- "--entrypoints.websecure.address=:443"   
      
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=dccn_net"

      - "traefik.http.routers.traefik-http.entrypoints=web"
      - "traefik.http.routers.traefik-http.rule=Host(`traefik.localhost`)"
      - "traefik.http.routers.traefik-http.middlewares=traefik-redirect-http"
      - "traefik.http.middlewares.traefik-redirect-http.redirectscheme.scheme=https"
      
      - "traefik.http.routers.traefik-https.entrypoints=websecure"
      - "traefik.http.routers.traefik-https.rule=Host(`traefik.localhost`)"

      - "traefik.http.routers.traefik-https.tls=true"
      - "traefik.http.routers.traefik-https.tls.options=default"
      - "traefik.http.routers.traefik-https.tls.certresolver=mycert"

      # traefik.http.middlewares.basic-auth-global.basicauth.users: <username>:<encoded-password>
      - "traefik.http.middlewares.basic-auth-global.basicauth.users=user:$$apr1$$iBy9InM6$$vxJGTqKth.ww3Ct8WVf2e1"
      - "traefik.http.routers.traefik-https.middlewares=basic-auth-global"
      
      - "traefik.http.services.traefik-https.loadbalancer.server.port=8080"

  nexus-service:
    image: sonatype/nexus3:latest
    container_name: nexus
    restart: always
    volumes:
      - "nexus-vol:/sonatype-work"
    networks:
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=dccn_net"

      # UI nexus
      - "traefik.http.routers.nexus-http.entrypoints=web"
      - "traefik.http.routers.nexus-http.rule=Host(`registry.localhost`)"

      - "traefik.http.routers.nexus-https.entrypoints=websecure"
      - "traefik.http.routers.nexus-http.service=nexus-https"
      - "traefik.http.routers.nexus-https.rule=Host(`registry.localhost`)"
      
      - "traefik.http.routers.nexus-https.tls=true"
      - "traefik.http.routers.nexus-https.tls.options=default"
      - "traefik.http.routers.nexus-https.tls.certresolver=mycert"

      - "traefik.http.routers.nexus-https.service=nexus-https"
      - "traefik.http.services.nexus-https.loadbalancer.server.port=8081"

      # docker.exam.ir
      - "traefik.http.routers.docker-http.entrypoints=web"
      - "traefik.http.routers.docker-http.rule=Host(`docker.localhost`)"
      
      - "traefik.http.routers.docker-https.entrypoints=websecure"
      - "traefik.http.routers.docker-http.service=docker-https"
      - "traefik.http.routers.docker-https.rule=Host(`docker.localhost`)"

      - "traefik.http.routers.docker-https.tls=true"
      - "traefik.http.routers.docker-https.tls.options=default"
      - "traefik.http.routers.docker-https.tls.certresolver=mycert"

      - "traefik.http.routers.docker-https.service=docker-https"
      - "traefik.http.services.docker-https.loadbalancer.server.port=8082"

      # nexus.localhost
      - "traefik.http.routers.mirror-http.entrypoints=web"
      - "traefik.http.routers.mirror-http.rule=Host(`nexus.localhost`)"

      - "traefik.http.routers.mirror-https.entrypoints=websecure"
      - "traefik.http.routers.mirror-http.service=mirror-https"
      - "traefik.http.routers.mirror-https.rule=Host(`nexus.localhost`)"

      - "traefik.http.routers.mirror-https.tls=true"
      - "traefik.http.routers.mirror-https.tls.options=default"
      - "traefik.http.routers.mirror-https.tls.certresolver=mycert"

      - "traefik.http.routers.mirror-https.service=mirror-https"
      - "traefik.http.services.mirror-https.loadbalancer.server.port=8083"
